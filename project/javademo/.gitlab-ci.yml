stages:
  - build
  - test
  - docker-build
  - deploy

variables:
  # å®šä¹‰é•œåƒç›¸å…³å˜é‡ï¼Œæ–¹ä¾¿ç»´æŠ¤
  HARBOR_REGISTRY: "registry.cn-shanghai.aliyuncs.com"
  IMAGE_NAME: "wql-k8s/javademo"  # è¯·ä¿®æ”¹ä¸ºä½ çš„å®é™…åº”ç”¨åç§°
  IMAGE_TAG: "$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"  # ä½¿ç”¨åˆ†æ”¯åå’Œæäº¤SHAä½œä¸ºæ ‡ç­¾

# åº”ç”¨æ„å»º
build-app:
  tags:
    - node
  image: registry.cn-shanghai.aliyuncs.com/wql-k8s/maven:3.9.9-amazoncorretto-21-alpine
  stage: build
  cache:
    paths:
      - .m2/repository/
  script:
    - echo "å¼€å§‹æ„å»º Java åº”ç”¨"
    - java -version
    - mvn -version
    - mvn clean package -DskipTests
    - echo "âœ… åº”ç”¨ç¼–è¯‘å®Œæˆ"
  artifacts:
    paths:
    paths:
      - target/classes/
      - target/*.jar
    expire_in: 1 hour

# ä»£ç è´¨é‡æ£€æŸ¥
code-quality:
  tags:
    - node
  image: registry.cn-shanghai.aliyuncs.com/wql-k8s/maven:3.9.9-amazoncorretto-21-alpine
  stage: test
  cache:
    paths:
      - .m2/repository/
    policy: pull
  script:
    - echo "è¿è¡Œæµ‹è¯•å’Œä»£ç æ£€æŸ¥"
    # - mvn test
    # - mvn checkstyle:check  # ä»£ç é£æ ¼æ£€æŸ¥ï¼Œå¦‚æœä¸éœ€è¦å¯ä»¥ç§»é™¤
    - echo "âœ… æµ‹è¯•é€šè¿‡"
  dependencies:
    - build-app
  # only:
  #   - merge_requests  # åªåœ¨åˆå¹¶è¯·æ±‚æ—¶è¿è¡Œæµ‹è¯•

# é•œåƒæ„å»º
build-image:
  tags:
    - node
  image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/docker:24.0.5  # ä½¿ç”¨ Docker å®¢æˆ·ç«¯é•œåƒ
  services:
    - name: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/docker:24.0.5-dind  # ä½¿ç”¨ Docker-in-Docker æœåŠ¡
      alias: docker
      command: ["dockerd", "--host", "tcp://0.0.0.0:2375", "--tls=false"]
  variables:
    # è®¾ç½® Docker å®¢æˆ·ç«¯ä½¿ç”¨ tcp è¿æ¥ dind æœåŠ¡
    DOCKER_HOST: "tcp://docker:2375"
    # ç¦ç”¨ TLS éªŒè¯
    DOCKER_TLS_VERIFY: ""
  stage: docker-build
  dependencies:
    - build-app  # ä¾èµ–æ„å»ºé˜¶æ®µ
  before_script:
    # ç­‰å¾… Docker æœåŠ¡å°±ç»ª
    - sleep 10
    - docker info || echo "Docker not ready yet"

  script:
    - echo "å¼€å§‹æ„å»º Docker é•œåƒ"
    - echo "ç™»å½• Harbor ä»“åº“"
    - echo "xxxx" > /tmp/password
    - cat /tmp/password | docker login -u "xxxx" --password-stdin $HARBOR_REGISTRY
    # éªŒè¯ç™»å½•
    - echo "ç™»å½•éªŒè¯:"
    - docker info | grep Registry || echo "Registry info not available"
    # æ„å»ºé•œåƒ
    - docker build -t $HARBOR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG .
    # æ¨é€é•œåƒåˆ° Harbor
    - docker push $HARBOR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
    # æ¸…ç†æœ¬åœ°é•œåƒ
    - docker rmi $HARBOR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
  after_script:
    - docker logout $HARBOR_REGISTRY

# éƒ¨ç½²
deploy:
  tags:
    - node
  image: registry.cn-shanghai.aliyuncs.com/wql-k8s/kubectl:latest
  stage: deploy
  dependencies: 
    - build-image
  before_script:
    - mkdir -p ~/.kube
    # åˆ›å»ºå®Œæ•´çš„ kubeconfig æ–‡ä»¶
    - |
      cat > ~/.kube/config << EOF
      apiVersion: v1
      clusters:
      - cluster:
          certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJTDk3cFVFMzdBZmd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBNU1qZ3dPVE16TVRWYUZ3MHpOVEE1TWpZd09UTTRNVFZhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUURKVUhKZXdiNHFtN0VMZHFzbkZFNnQ5ZzBnWXNnR3NucFRmMTdPQXlkWjFkMDI4dTRBMWRLYmpzOUoKSnFsdS9yQTUzejQ2OWlzTXNuaVVNeU4rRFdXSyt3Q3VaNEVDRzVhUW5WZDFhUjAwTHZZS2lSQnI5TXkrMVc1TApQei9Ic3JPd3cwWWtYVXVWczQveDV1c2dVQ05DZXFRQlhpRk9VMDlUU0pZb3IzbWFWMWQvWlY4algzSTdxVU9UCnIwSGxUdEhBdW92ZVNtRXpUa0ZWd2tUMXo3bGl3QnFabndzQ2xXWWdTUkI2VUlOVDZQTzNNbXNqMFNhOFhMSGsKc0cwTnJjLy9MYk10d3FDak5WM1h3YzRjNURyeE52a3JLNUdabU1CRWlRN3FPVXUrbW9FU3U0aFNkaThqVk5BYgpSejM4MXl6T2RCQ1RZaHJWU21LYlo4S2JidlpIQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJUTEk0SFUzdkpNaURMVnVtdDhjamFrbHdueCtEQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQjZPVXpuaW9xYQowcDZ1MkwyRDFZYVRiUzJlcWduaktvQ1hmdWV5WThhNXQ1bGwwOVUxQm1zcVJMWWZPS25iWGJZYno5a2dhMHIzCk1yaFk2aDduQU5qYk5TVndyVkduYVpqeTBNdXFIc1V0cWVxZEtHNU15NW05WWNpSUd4VHZsVTYwb09CMkVKQWsKTk1OK3daZk9OSkM2ZU02eTRiV1NCV2NIVUt6bEtTM3h4WC9Tbmg3M2VNQ25KZlRXdDlEem9VRHpmTUZBTFA1TApqemdCRkRmVjdPeWM2ckdNWjdFWklnQlR5ZmIxV293U3dZSmk5OUhDbVlRZzhERFJDTzJnU2xsZUlQaHJkUStICll3alUyc3ZXWHN4aGdybXIwNEkvTk9oeFVoaVorN00zUkZHVHI0VVJTeVQ4UDFuT1VBOGQ3VGxZTmVGNE9VYnMKdGhYbThRL0kxN0dICi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
          server: https://xx.xx.xx.xx:6443
        name: kubernetes
      contexts:
      - context:
          cluster: kubernetes
          user: kubernetes-admin
        name: kubernetes-admin@kubernetes
      current-context: kubernetes-admin@kubernetes
      kind: Config
      users:
      - name: kubernetes-admin
        user:
          client-certificate-data: FFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBNU1qZ3dPVE16TVRWYUZ3MHlOakE1TWpnd09UTTRNVFZhTUR3eApIekFkQmdOVkJBb1RGbXQxWW1WaFpHMDZZMngxYzNSbGNpMWhaRzFwYm5NeEdUQVhCZ05WQkFNVEVHdDFZbVZ5CmJtVjBaWE10WVdSdGFXNHdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEd1A4S0UKdWx3djRGNEplMWFYZXRRWkZTRVUvTGNyRzRaTk9NTzdCd0RJalB6eENqK3FVcThoNUt6UWpWdXh6M0dBbEs1MgpzckJSNHIwbWwxQ3JWaGliN1lYSnExZGppeDZkMkhxaGpjc0pQTXNVU2VzWENvWEhLSVhsS1A3YU9NV3lDUUc0ClFXLzlDZFIyQWVISFdRUHRtR2x5L1RpVDNUR243L3huZGNobmRkTTdPVktBQWpBcEt0K2cybHN2cGpzcUdKbEgKLy94UXdHVUdaWi9CZDNCTDM2K05iTGlua05KRmhCOTZyaFQ3N0s5UjZkcFVTaG1CUjRYa2Q0N0VsSDVWS2JrLwpQOGdESFBaamU3dTJJYWJBRDQwK0hUdDJZQkEzUTVxOG5ueTl5TWptNW1lMzExbHd0SFRmL2VYN28ycUlYdUcrClJZNFUwRUJWN1pDL0ptb0RBZ01CQUFHalZqQlVNQTRHQTFVZER3RUIvd1FFQXdJRm9EQVRCZ05WSFNVRUREQUsKQmdnckJnRUZCUWNEQWpBTUJnTlZIUk1CQWY4RUFqQUFNQjhHQTFVZEl3UVlNQmFBRk1zamdkVGU4a3lJTXRXNgphM3h5TnFTWENmSDRNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUJ0bWg1anplRWh6VENsZjk5OHEvS2NnTm4wCjBVaGw0eEpTSVFnVFVDRTJVK3ZUbEY5bFNTWTNQMjZlNmVmajV4ZHBFQnhLU3BKNXc2dzlKTG1SQmd0cnlsVncKRGpKOHJUN2N1S3lhZTJqUjNRMDZ6aXNzYnBpT2VTcmV5WjFObmh6cDIxTFBBNXllaHp4RkVHaEh3STlYL0VZUwo0NlhhbFhmTENqbktsL2I1RnNKZGdvQTFhREc4Zks4emdSVjNPK0N4cG93aEo4VEx6MDFTZ2dEQm9HR2VVcy9xClNNNGMyWE5TakoyMm05SjlnMWVoNlk4MVpxc3U3N0owUWxOM2t6MFVGdE45enVaTUV1cHJqdXM3NkV6OUwzMHYKeDMyQ2FoTlRqSFhsNkdJcmtCR3RzL1VONHNjbVhoOUVYNFZ1TjYyYnRvVVk4Vi94SUpSQisyMUViRnk0Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
          client-key-data: 4UW8vCnFsS3ZJZVNzMEkxYnNjOXhnSlN1ZHJLd1VlSzlKcGRRcTFZWW0rMkZ5YXRYWTRzZW5kaDZvWTNMQ1R6TEZFbnIKRndxRnh5aUY1U2orMmpqRnNna0J1RUZ2L1FuVWRnSGh4MWtEN1pocGN2MDRrOTB4cCsvOFozWElaM1hUT3psUwpnQUl3S1NyZm9OcGJMNlk3S2hpWlIvLzhVTUJsQm1XZndYZHdTOSt2ald5NHA1RFNSWVFmZXE0VSsreXZVZW5hClZFb1pnVWVGNUhlT3hKUitWU201UHovSUF4ejJZM3U3dGlHbXdBK05QaDA3ZG1BUU4wT2F2SjU4dmNqSTV1Wm4KdDlkWmNMUjAzLzNsKzZOcWlGN2h2a1dPRk5CQVZlMlF2eVpxQXdJREFRQUJBb0lCQUdQaUxrNGVhTnRpemRYbApXRy9zR2lnL2Q1eVJJTm9rUEdiNGxhKzVUcU1Tc3NySDl3WXFFRFBvTGMwYktDYzUxcmVkbVJjeVhVbitHYVBrCnZ4NHMwbGhwblBqbWFwT3hNRTV4eFRKTGtFRkw3Q2FJUU53NGZMdjdaZ2VMVHNHTlh1d1JBSTBKYjdUbEZGYm4KbTJYVTVXUXZ2SStaSlorY0U5djlVNVAwRFJpdHZweTFaVkxsT2ZFcmM1MWpxQWo1eElNS21CcVBTVzc1ZmFZYgpjb2ZVR1p0VjBCdE1SQVBBa3dRVUYzQ0lMQjYwWFNXeHBYNmZ0Mno2WmhaYmV5UFdsNG9hTCtvTkNYWXdTL25kCkdSMWk3eTVIU3pyVWg4dmZCZVpab3VEUDFwSGxQZVo4YWE4dy82c3V2V1U1Zm85aWpMd0RIZlZkN3BibWZkYVkKR01EQkdvRUNnWUVBOHRWTzJnU1BSWW9PcThFd3NkN3JQTTZSZGRRRDFKUFRrWnRFMjdDbkFwWEZleG5FeGJlcQpqSTRoMlllWEV4cmJIaytmQ3NITTgwOWZEblcwcXFFMEo5OGZUbFliN21KWTY5Zm55MnR3Q1ZRTktuVExtT2VpCnV2Vng3bURkVVF6NXFMVzlJcVdMSTRYeG52U3E0dFlSYnVNNjNROXZZczVRR2R1Q05rL3Avc0VDZ1lFQS9VYVUKN0kxR3hMZGJPSEQvNklxVW9JYXpDSFZRd3hUSzlXQ3dTNTh0d0JHR3ZPYnF1cjRGd2trWkg4blkzbHNYM09MLwpab2w4YUE5OENEaFdTSmVaL3BzN0U3Q1VWQjJLYXJkamQ2RThUbkRyTVdTWGQxREpnd1RyN0JmdVVBYVN3SUt4ClV5c2lFRWJlK3F6RkZkK0k4WUNFc0cyKzBsSHhqb3JURmdidG5jTUNnWUVBNmMydlNnS3gzNFo1Y2Exa3NSMnMKNkxNTElxT3J2SFZJY3gxSVF5M20zM3BNMWFXTjY4QlhHVldRQ2QyZSsrb1RweStLTmRVNis5a2o4TXdyMDAyNgo1ZGpTVDU1Zzdqa0szS2pZcU9jY3pCNTlQcStOaC84ZWsxdlhBbW1KTFl5TXBIKzNSekNVc3ZNNEhJLytLTUZyCnI1UmhESTdiOUFvbzNYeVg5cXNpNVFFQ2dZRUF5em1aUVgzU3JRR2E5bHpsV2tmb0hpNDI5YkI4anl2ZDlxb1EKaTMwOERvT0JvNDErQnoxMkRZRHQ0ZTNxVC9DejR3OVpjNE1hQ2IxeS9uMkY3bFdHd1I3NWRrRVhvNjdZWSt5bQpxVlQ4dU13dVM4RzFMNDNwUTNIdGc5Rm43VnA0NG5ON3FZcFFtTkxsRkNzUk1RM2VLam0vUG5td3hiM3VuenVSClNIbGlyRlVDZ1lCL01YcEZhOENLSmZYU0tobmlGSzJrMm52L0trWVNhYVQ0S1VsTkRMUWZ1NWtoMGFvVzdaYzkKdnI2VHp4V2FVSWlOQ1FnK2hLcE4vMFo3UGRFem9QNWN5MVR5TlFnZXBZOXVJMVJZWmh6bDREV05HcWV4cjhwbgpJWnB2Q3BPdzQ5amJMSU85bkE1ZXF1ZForL3MveWoyeHorNnZ2YmpJVlhCbUNZYmVIK2cyUXc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
      EOF
    - chmod 600 ~/.kube/config
    - env
  script:
    - echo "å½“å‰ kubeconfig å†…å®¹:"
    - cat ~/.kube/config
    - echo "å½“å‰ä¸Šä¸‹æ–‡:"
    - kubectl config current-context
    - echo "å°è¯•åˆ—å‡ºèŠ‚ç‚¹:"
    - kubectl get nodes
    - echo "ğŸš€ éƒ¨ç½²åˆ° Kubernetes"
    - echo "ä½¿ç”¨é•œåƒ:" $HARBOR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
    - kubectl set image deployment/javademo javademo=$HARBOR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG -n wql

    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    - kubectl rollout status deployment/javademo -n wql --timeout=300s
    
    # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
    - echo "=== éƒ¨ç½²è¯¦æƒ… ==="
    - kubectl get deployment,service,pod -n wql -l app=javademo
    
    # è·å–æœåŠ¡è®¿é—® URL
    - |
      NODE_PORT=$(kubectl get service javademo-service -n wql -o jsonpath='{.spec.ports[0].nodePort}')
      echo "ğŸŒ åº”ç”¨å¯é€šè¿‡ NodePort è®¿é—®: http://<é›†ç¾¤ä»»æ„èŠ‚ç‚¹IP>:$NODE_PORT"
  only:
    - main  # åªåœ¨ main åˆ†æ”¯è§¦å‘éƒ¨ç½²